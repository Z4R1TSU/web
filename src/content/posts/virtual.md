---
title: "虚函数相关面试题"
description: "这是一篇关于虚函数相关面试题的文章，主要介绍了虚函数的概念、创建、调用方式、存放位置等。"
pubDatetime: 2023-09-07
author: Zari Tsu
featured: false
draft: false
tags:
  - cpp
---


# 虚函数

> 虚函数是实现多态的一种方式，它允许派生类对基类中同名函数的重新定义，从而使得派生类对象在运行时调用基类中同名函数时，调用的是派生类中重新定义的函数。

### 虚函数的本质

1. 虚函数表(virtual table)：存放所有类的虚函数的地址的一个数组，每个类都有一个虚函数表。

2. 虚函数指针(virtual function pointer)：指向虚函数表中某个虚函数的指针。

3. 虚函数调用：当调用虚函数时，实际上是调用虚函数指针指向的函数。

### 虚函数的存放位置

> 存放在全局数据区的只读数据区(read-only data section)

1. 全局虚函数表(global virtual table)：存放所有类的虚函数的地址，每个类都有一个全局虚函数表。

2. 每个类的虚函数表(virtual table)：存放该类的虚函数的地址，每个类都有一个虚函数表。

### 虚函数创建的情况

> 在编译期

1. 编译器发现virtual关键字

2. 虚函数表(virtual table)的创建

3. 编译器生成虚函数的调用代码

### 虚函数的调用方式

1. 静态绑定(static binding)：在编译期确定调用哪个虚函数，调用的是虚函数表中的函数地址。

2. 动态绑定(dynamic binding)：在运行期确定调用哪个虚函数，调用的是虚函数指针指向的函数。

### 我的总结

虚函数其实在类当中隐式地增加了一个成员函数，用来指向虚函数表所在的一个指针，这个指针指向了虚函数表中存放的虚函数的地址。

在带有virtual关键词的类A，在构造期间，会将虚函数表的地址存放在类的全局数据区，在运行期间，会将这个地址赋值给虚函数指针。假设这时候有一个类B派生于A类，那么在B的构造函数中，B会生成一个成员变量指向自己的虚函数表，然后B的成员函数会时不时地更换指向，一会指向A的虚函数表，一会指向B的虚函数表。

虚函数的灵魂是虚函数表，它在编译期间就已经确定了，运行期间才会确定调用哪个虚函数。
* 因此**构造函数(constructor)**不可以是虚函数，因为构造函数是在对象创建的时候调用的，而虚函数表是在编译期间就已经确定了，运行期间才会确定调用哪个虚函数。
* 析构函数(destructor)可以是虚函数，因为析构函数是在对象销毁的时候调用的，而虚函数表是在编译期间就已经确定了，运行期间才会确定调用哪个虚函数。